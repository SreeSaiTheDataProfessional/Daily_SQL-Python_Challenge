WITH open_and_send AS (
    SELECT 
        a.user_id,
        ab.age_bucket,
        a.time_spent,
        a.activity_type
    FROM activities a
    JOIN age_breakdown ab 
        ON a.user_id = ab.user_id
    WHERE a.activity_type IN ('send', 'open')
)
SELECT 
    age_bucket,
    ROUND(
        100.0 * SUM(time_spent) FILTER (WHERE activity_type = 'send')
        / SUM(time_spent), 
        2
    ) AS send_perc,
    ROUND(
        100.0 * SUM(time_spent) FILTER (WHERE activity_type = 'open')
        / SUM(time_spent), 
        2
    ) AS open_perc
FROM open_and_send
GROUP BY age_bucket
ORDER BY age_bucket;


      
        
